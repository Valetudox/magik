# Upstream backend services
upstream backend_decision {
    server backend-decision:3000;
}

upstream backend_audio {
    server backend-audio:3002;
}

upstream backend_specification {
    server backend-specification:3003;
}

upstream backend_socket {
    server backend-socket:3001;
}

upstream ui_decision {
    server ui-decision:80;
}

upstream ui_audio {
    server ui-audio:80;
}

upstream ui_specification {
    server ui-specification:80;
}

# Main server block
server {
    listen 80;
    server_name localhost;

    # Increase buffer sizes for large headers
    large_client_header_buffers 4 16k;

    # Gateway health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ok","gateway":"healthy"}';
    }

    # Gateway status endpoint (checks all services)
    location = /health/all {
        access_log off;
        add_header Content-Type application/json;

        # This is a simple check - returns 200 if gateway is up
        # Individual service health should be checked via their endpoints
        return 200 '{"status":"ok","services":["backend-decision","backend-audio","backend-specification","backend-socket","ui-decision","ui-audio","ui-specification"]}';
    }

    # API endpoints - Decision API
    location /api/decisions {
        proxy_pass http://backend_decision;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # API endpoints - Audio/Recordings API
    location /api/recordings {
        proxy_pass http://backend_audio;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # API endpoints - Specification API
    location /api/specifications {
        proxy_pass http://backend_specification;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Socket.IO WebSocket connection
    location /socket.io/ {
        proxy_pass http://backend_socket;
        proxy_http_version 1.1;

        # WebSocket specific headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
    }

    # Decision UI - serve from /decisions path
    location /decisions/ {
        # Rewrite /decisions/* to /* for the upstream
        rewrite ^/decisions/(.*)$ /$1 break;
        proxy_pass http://ui_decision;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Decision UI - redirect /decisions to /decisions/
    location = /decisions {
        return 301 /decisions/;
    }

    # Audio UI - serve from /audio path
    location /audio/ {
        # Rewrite /audio/* to /* for the upstream
        rewrite ^/audio/(.*)$ /$1 break;
        proxy_pass http://ui_audio;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Audio UI - redirect /audio to /audio/
    location = /audio {
        return 301 /audio/;
    }

    # Specification UI - serve from /specifications path
    location /specifications/ {
        # Rewrite /specifications/* to /* for the upstream
        rewrite ^/specifications/(.*)$ /$1 break;
        proxy_pass http://ui_specification;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Specification UI - redirect /specifications to /specifications/
    location = /specifications {
        return 301 /specifications/;
    }

    # Root - redirect to decisions UI
    location = / {
        return 302 /decisions;
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;
}
