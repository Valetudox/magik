services:
  # Nginx Gateway
  gateway:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-gateway:latest
    build:
      context: .
      dockerfile: apps/gateway/Dockerfile
    container_name: magik-gateway
    ports:
      - '80:80'
    networks:
      - magik-network
    depends_on:
      backend-decision:
        condition: service_healthy
      backend-audio:
        condition: service_healthy
      backend-socket:
        condition: service_healthy
      backend-specification:
        condition: service_healthy
      ui-decision:
        condition: service_healthy
      ui-audio:
        condition: service_healthy
      ui-specification:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1/health']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Backend Socket Server
  backend-socket:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-backend-socket:latest
    build:
      context: .
      dockerfile: apps/backend-socket/Dockerfile
    container_name: magik-backend-socket
    environment:
      - PORT=3001
    networks:
      - magik-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 15s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Backend Decision API
  backend-decision:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-backend-decision:latest
    build:
      context: .
      dockerfile: apps/backend-decision/Dockerfile
    container_name: magik-backend-decision
    environment:
      - PORT=3000
      - SOCKET_SERVER_URL=http://backend-socket:3001
      - DECISIONS_DIR=/data/decisions
      - NODE_ENV=production
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
    volumes:
      - ${DECISIONS_DIR:-/home/magic/Documents/decisions}:/data/decisions
      - ${HOME}/.config/claude-code:/root/.config/claude-code
    networks:
      - magik-network
    depends_on:
      backend-socket:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/decisions']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Backend Audio API
  backend-audio:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-backend-audio:latest
    build:
      context: .
      dockerfile: apps/backend-audio/Dockerfile
    container_name: magik-backend-audio
    environment:
      - PORT=3002
      - RECORDINGS_DIR=/data/recordings
      - NODE_ENV=production
    volumes:
      - ${RECORDINGS_DIR:-/home/magic/Documents/recordings}:/data/recordings
    networks:
      - magik-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3002/health']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 15s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Backend Specification API
  backend-specification:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-backend-specification:latest
    build:
      context: .
      dockerfile: apps/backend-specification/Dockerfile
    container_name: magik-backend-specification
    environment:
      - PORT=3003
      - SPECIFICATIONS_DIR=/data/specifications
      - NODE_ENV=production
    volumes:
      - ${SPECIFICATIONS_DIR:-/home/magic/repositories/magik/specs}:/data/specifications:ro
    networks:
      - magik-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3003/api/specifications']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # UI Decision Frontend
  ui-decision:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-ui-decision:latest
    build:
      context: .
      dockerfile: apps/ui-decision/Dockerfile
    container_name: magik-ui-decision
    networks:
      - magik-network
    depends_on:
      backend-decision:
        condition: service_healthy
      backend-socket:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1/']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # UI Audio Frontend
  ui-audio:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-ui-audio:latest
    build:
      context: .
      dockerfile: apps/ui-audio/Dockerfile
    container_name: magik-ui-audio
    networks:
      - magik-network
    depends_on:
      backend-audio:
        condition: service_healthy
      backend-socket:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1/']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # UI Specification Frontend
  ui-specification:
    image: ${DOCKER_REGISTRY:-localhost:5000}/magik-ui-specification:latest
    build:
      context: .
      dockerfile: apps/ui-specification/Dockerfile
    container_name: magik-ui-specification
    networks:
      - magik-network
    depends_on:
      backend-specification:
        condition: service_healthy
      backend-socket:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1/']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

networks:
  magik-network:
    driver: bridge
